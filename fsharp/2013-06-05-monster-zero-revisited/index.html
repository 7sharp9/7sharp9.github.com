<!doctype html><html><head><title>Monster Zero - Revisited &#183; 7sharp9</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.82.1"><link rel=stylesheet href=https://7sharp9.dev/css/vec.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.ico><link href rel=alternate type=application/rss+xml title=7sharp9></head><body><header><nav><ul><li class=pull-left><a href=https://7sharp9.dev/>/Home</a></li><li class=pull-left><a href=/about>/About</a></li><li class=pull-left><a href=/fsharp>/F#</a></li><li class=pull-left><a href=/running>/Running</a></li><li class=pull-left><a href=/elm>/Elm</a></li><li class=pull-right><a href><i class="fas fa-rss"></i></a></li></ul></nav></header><div class="content wide"><section class=post><h1 class=post-title><a href=https://7sharp9.dev/fsharp/2013-06-05-monster-zero-revisited/>Monster Zero - Revisited</a></h1><span class=post-date>Jun 5, 2013</span><div class=post-content><p><figure class=img-left><img src=http://upload.wikimedia.org/wikipedia/en/c/ce/KingGhidorah.jpg></figure><br>This creature is capable of tremendous destruction due to it&rsquo;s size, flight <em>(with the creature&rsquo;s wings also generating hurricane strength winds)</em> and possesses several breath weapons <em>(e.g., heat and energy)</em>.</p><p>What am I talking about here? Maybe it&rsquo;s <a href=http://en.wikipedia.org/wiki/King_Ghidorah>Monster Zero</a> or <a href=http://en.wikipedia.org/wiki/King_Ghidorah>King Ghidorah</a> as it&rsquo;s sometimes known. No it&rsquo;s <a href=http://msdn.microsoft.com/en-us/library/hh228603.aspx>TPL Dataflow</a>!</p><p>Yeah, yeah, I have a penchant for being over dramatic and writing quirky intros. This post is about <a href=http://msdn.microsoft.com/en-us/library/hh228603.aspx>TPL Dataflow</a> otherwise known as TDF. I have blogged about this before in my <a href=https://7sharp9.dev/fsharp/fsharp-dataflow-agents-i/>TDF agent series</a> but I thought it might be worth while returning to it while on the subject of monsters.</p><p>The purpose of these posts is not to put you of using these libraries but to give you feel of how they might be used from an F# viewpoint. Its not always easy to use these libraries even from C#, so jumping to another paradigm can sometimes leave you feeling bewildered, frustrated and lost.</p><h3 id=what-is-tpl-dataflow>What is TPL Dataflow</h3><p>According to MSDN here&rsquo;s the description of TPL dataflow:</p><blockquote><p>The Task Parallel Library (TPL) provides dataflow components to help increase the robustness of concurrency-enabled applications. These dataflow components are collectively referred to as the TPL Dataflow Library. This dataflow model promotes actor-based programming by providing in-process message passing for coarse-grained dataflow and pipelining tasks.</p></blockquote><p>Checkout the <a href=http://msdn.microsoft.com/en-us/library/hh228603.aspx>MSDN</a> if you want to read a more in depth outline on TDF, or you could also refer to my <a href=https://7sharp9.dev/fsharp/fsharp-dataflow-agents-i/>earlier posts</a> too.</p><h3 id=sample-problem>Sample problem</h3><p>Here&rsquo;s a sample problem: We have two documents that we want to use to collate a list of word occurrences, we then want to collect the results from both documents and print out the combined results.</p><p>Although we&rsquo;re using TDF to solve this problem, we could of also used F# agents, Reactive Extensions, Linq, TPL, or a mix of all of those.</p><p>We will stick to using the <a href=http://msdn.microsoft.com/en-us/library/dd233175.aspx>F# REPL</a> for this post as it&rsquo;s fairly simple example and allows for a bit of interactivity. Lets start by adding a reference, open up a few namespace&rsquo;s and read a couple of text files in. In this instance we&rsquo;re going to use <a href=http://en.wikipedia.org/wiki/Jane_Eyre>Jane Eyre</a> by Charlotte Bronte, and <a href=http://en.wikipedia.org/wiki/Algernon_Blackwood#Novels>The Wendigo</a> by Algernon Blackwood, for no reason other than they were free to download and use as samples.</p><pre><code>#r &quot;System.Threading.Tasks.Dataflow&quot;
open System
open System.IO
open System.Threading.Tasks.Dataflow

let janeEyre = File.ReadAllText(@&quot;Jane Eyre [Charlotte Bronte].txt&quot;)
let theWendigo = File.ReadAllText(@&quot;The Wendigo [Algernon Blackwood].txt&quot;)
</code></pre><p>The next thing we need to think about is how to count the words. Let&rsquo;s create a recursive function that counts each occurrence of a passed in word against the full text. The <code>wordCount</code> function recurses until <code>-1</code> is returned from the <code>IndexOf</code> function. Before you argue about memory allocation, laziness etc, we&rsquo;re not interested in that at the moment, we just want to solve the problem at hand. It would be fairly easy to split the input into a lazy sequence and iterate over it so we only keep a single line in memory.</p><pre><code>let wordCount (text: String) word =
   let rec loop position count =
      match text.IndexOf(word, position, StringComparison.InvariantCultureIgnoreCase) with
      | -1 -&gt; count
      | i -&gt;  loop (i + word.Length) (count + 1)
   loop 0 0
</code></pre><p>Now we can start to create some TDF blocks, we shall create a <a href=http://msdn.microsoft.com/en-us/library/hh160447.aspx>BroadcastBlock</a> first.</p><blockquote><p>A BroadcastBlock provides a buffer for storing at most one element at time, overwriting each message with the next as it arrives.</p></blockquote><p>Messages are broadcast to all linked targets, all of which may consume a clone of the message.</p><p>The lambda expression passed into the <code>BroadcastBlock</code> is it&rsquo;s clone function, in this case we will just use the string that is passed in: <code>fun s -> s</code>. We will be using the <code>BroadcastBlock</code> to send the same message to multiple destinations later on.</p><pre><code>let broadcast = BroadcastBlock(fun s -&gt; s)
</code></pre><p>Now we will create a couple of <a href=http://msdn.microsoft.com/en-us/library/hh194782.aspx>TransformBlocks</a>.</p><blockquote><p>A TransformBlock provides a dataflow block that invokes a provided Func(T, TResult) delegate for every data element received.</p></blockquote><p>The <code>TransformBlock</code> will accept a data element and transform it by invoking it&rsquo;s transform function. Here we will <a href=http://msdn.microsoft.com/en-us/library/dd233229.aspx>partially apply</a> the <code>wordCount</code> function by passing in the first parameter <code>text</code>. This means that whenever the <code>TransformBlock</code> is passed data the <code>wordCount</code> function will already have the <code>text</code> parameter applied and will return the number of matches from the document. The context of passed data here will be the word that we want to find. We&rsquo;ll create one for Jane Eyre and one for The Wendigo:</p><pre><code>let transformJaneEyre = TransformBlock(wordCount janeEyre)
let transformTheWendigo  = TransformBlock(wordCount theWendigo)
</code></pre><p>Now that we have created three blocks we need to think about linking them together. You can do this with the <code>LinkTo</code> method that every dataflow block has. We could do that by calling the <code>LinkTo</code> methods as usual like this:</p><pre><code>broadcast.LinkTo(transformJaneEyre) |&gt; ignore
broadcast.LinkTo(transformTheWendigo) |&gt; ignore
</code></pre><p>That seems a little awkward, especially as we&rsquo;re not interested in the return parameter in this example, so instead we&rsquo;re going to create a little function to make this a little bit easier for ourselves:</p><pre><code>let (--&gt;) source target = DataflowBlock.LinkTo(source, target) |&gt; ignore
</code></pre><p>The <code>LinkTo</code> method returns an <code>IDisposable</code> that can be use to sever the link between the blocks that have just been joined. There are also overloads of <code>LinkTo</code> that allow you to specify a predicate. There is also an overload that takes a <code>DataflowLinkOptions</code> type which allows you to specify whether the new link is appended (<code>Append</code>), the maximum message that can be passed before the block is unlinked (<code>MaxMessages</code>), and finally and whether or not the completion of the former block is propagated to the latter (<code>PropagateCompletion</code>).</p><p>We can now use the <code>--></code> symbolic operator and use <a href=http://msdn.microsoft.com/en-us/library/dd233204.aspx>infix notation</a> to link the blocks together. Infix operators are expected to be placed between the two operands, which means we can define the links between the block like this:</p><pre><code>broadcast --&gt; transformJaneEyre
broadcast --&gt; transformTheWendigo
</code></pre><p>Next we create a <a href=http://msdn.microsoft.com/en-us/library/hh160286.aspx>JoinBlock</a>.</p><blockquote><p>A JoinBlock provides a dataflow block that joins across multiple dataflow sources, which are not necessarily of the same type, waiting for one item to arrive for each type before theyâ€™re all released together as a tuple that contains one item per type.</p></blockquote><pre><code>let join = JoinBlock&lt;_,_,_&gt;()

broadcast           --&gt; join.Target1
transformJaneEyre   --&gt; join.Target2
transformTheWendigo --&gt; join.Target3
</code></pre><p>We create the <code>JoinBlock</code> then link the <code>broadcast</code>, <code>transformJaneEyre</code>, and <code>transformTheWendigo</code> to it. This means that the <code>JoinBlock</code> will wait for data from <strong>all</strong> three blocks before sending the data on as a tuple of the three values.</p><p>Finally we create the last block which is an <a href=http://msdn.microsoft.com/en-us/library/hh194684.aspx>ActionBlock</a></p><blockquote><p>An ActionBlock provides a dataflow block that invokes a provided Action(T) delegate for every data element received.</p></blockquote><pre><code>let writeOutput = 
    ActionBlock(fun(word:String, count1, count2) -&gt; 
       Console.WriteLine(&quot;Word: {0}, Jane Eyre: {1}, The Wendigo: {2}&quot;, 
                         word.PadRight(10),
                         (string count1).PadLeft(3), 
                         (string count2).PadLeft(3) ) )
    
join --&gt; writeOutput
</code></pre><p>Right, that completes the hook up, now all that&rsquo;s left is to test it.</p><pre><code>let words = [|&quot;cat&quot;;&quot;cake&quot;;&quot;anything&quot;;&quot;laugh&quot;;&quot;breeze&quot;;&quot;hysterical&quot;;&quot;ball&quot;;&quot;them&quot;;&quot;home&quot;;&quot;bird&quot;|]
for word in words do 
  broadcast.Post(word) |&gt; ignore
</code></pre><p>If we execute this then we we get the following output:</p><pre><code>Word: cat       , Jane Eyre: 212, The Wendigo:  73
Word: cake      , Jane Eyre:  15, The Wendigo:   0
Word: anything  , Jane Eyre:  60, The Wendigo:  19
Word: laugh     , Jane Eyre:  68, The Wendigo:  17
Word: breeze    , Jane Eyre:  11, The Wendigo:   0
Word: hysterical, Jane Eyre:   1, The Wendigo:   1
Word: ball      , Jane Eyre:  11, The Wendigo:   1
Word: them      , Jane Eyre: 432, The Wendigo:  72
Word: home      , Jane Eyre:  90, The Wendigo:  11
Word: bird      , Jane Eyre:  35, The Wendigo:   0
</code></pre><h3 id=summary>Summary</h3><p>From a conceptual viewpoint of view we&rsquo;re creating a BroadcastBlock which connects to two TransformBlocks. The two TransformBlocks are then connected to the JoinBlock along with the BroadcastBlock. Finally, the JoinBlock is connected to the ActionBlock.</p><p>This creates a mini network where you can simply post a message to the input of the dataflow network and it will propagate through the network. As with Reactive Extensions marble diagrams and pipeline diagrams are a great way to visualise the process flow.</p><figure><img src=https://lh5.googleusercontent.com/-r5TZAl6VERo/UbCwd4MXGTI/AAAAAAAABpg/MmQIb_0nwb8/w769-h218-no/Screen+Shot+2013-06-06+at+16.50.31.png></figure><p>I hope that sheds a little bit of light on how a dataflow network can be created with TDF. Extremely complex behaviour&rsquo;s can be created by connecting up the simple dataflow building blocks, especially as the different block&rsquo;s can run with multiple degrees of parallelism an also run asynchronously using <code>Task&lt;T></code>.</p><p>Until next time!</p></div></section><section class="pagination clearfix"><a class="btn previous" href=https://7sharp9.dev/fsharp/2013-06-01-some-kind-of-monster/>Some kind of monster</a>
<a class="btn next" href=https://7sharp9.dev/fsharp/2013-06-21-can-i-have-some-fsharp-with-that/>Can I have some F# with that?</a></section><section id=disqus_thread class=disqus></section><script>var disqus_config=function(){this.page.url="https://7sharp9.dev/fsharp/2013-06-05-monster-zero-revisited/"};(function(){var a=document,b=a.createElement('script');b.src='//7sharp9.disqus.com/embed.js',b.setAttribute('data-timestamp',+new Date),(a.head||a.body).appendChild(b)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div><footer><div class="footer-info pull-right">Â© 2021 Dave Thomas</div></footer><script src=https://7sharp9.dev/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-10152365-8','auto'),ga('send','pageview')</script></body></html>