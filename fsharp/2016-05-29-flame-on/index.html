<!doctype html><html><head><title>flame on &#183; 7sharp9</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.82.1"><link rel=stylesheet href=https://7sharp9.dev/css/vec.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.ico><link href rel=alternate type=application/rss+xml title=7sharp9></head><body><header><nav><ul><li class=pull-left><a href=https://7sharp9.dev/>/Home</a></li><li class=pull-left><a href=/about>/About</a></li><li class=pull-left><a href=/fsharp>/F#</a></li><li class=pull-left><a href=/running>/Running</a></li><li class=pull-left><a href=/elm>/Elm</a></li><li class=pull-right><a href><i class="fas fa-rss"></i></a></li></ul></nav></header><div class="content wide"><section class=post><h1 class=post-title><a href=https://7sharp9.dev/fsharp/2016-05-29-flame-on/>flame on</a></h1><span class=post-date>May 29, 2016</span><div class=post-content><p>A few weeks back I posted on Twitter that I was experimenting with flame graphs, In this post I will share how this was accomplished.</p><h3 id=requirements>Requirements</h3><p>First of all the requirements, I&rsquo;m assuming your using a Mac just as I am. If you are not then you might be able to use x-perf for windows check out <a href=https://randomascii.wordpress.com/2013/03/26/summarizing-xperf-cpu-usage-with-flame-graphs/>summarizing-xperf-cpu-usage-with-flame-graphs</a> for information in that area. I don&rsquo;t really use Windows that often but if I do happen to try this out on Windows then I&rsquo;ll pop back here and update this post.</p><p>OK, so back to requirements, a Mac, Mono Installation, <a href=https://developer.apple.com/xcode/>Xcode</a> installed so that you can use <a href=https://developer.apple.com/library/tvos/documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/#//apple_ref/doc/uid/TP40004652-CH3-SW1>Instruments</a> to collect trace information, clone the FlameGraph repo itself:</p><pre><code>git clone https://github.com/brendangregg/FlameGraph
</code></pre><p>The FlameGraph repo is a bunch of scripts to help process the trace data and produce an svg. You can read more about FlameGraphs here: <a href=http://www.brendangregg.com/flamegraphs.html>http://www.brendangregg.com/flamegraphs.html</a></p><h3 id=aot-the-framework>AOT the framework</h3><p>Next step is to AOT compile all the mono runtime assemblies, you can do this by running the following commands from your mono installation. For me this would be:</p><pre><code>cd /Library/Frameworks/Mono.framework/Versions/4.4.0/lib/mono/
for i in `find gac -name '*dll'` */mscorlib.dll; do
   mono --aot $i
done
</code></pre><h3 id=aot-your-app>AOT Your app</h3><p>Now you need to AOT you applications files with the same command</p><pre><code>mono --aot myApp.exe
</code></pre><h3 id=attaching-instruments>Attaching Instruments</h3><p>Now you are ready to run your app and attach Instruments or have Instruments launch your app.</p><p>For simplicity I opted to add this to the beginning of my app:</p><pre><code>printfn &quot;Press any key to start&quot;
Console.ReadKey() |&gt; ignore
</code></pre><p>That way I could just launch my app (noting the process id) and use the process browser within Instruments to attach.<br>Now launch Instruments and select the Time Profiler template:</p><figure class=6u><img src=/img/flame-on/timeprofiler-template.png></figure><p>You can tweak the sampling interval with the settings on the right, in my example below I was using 40us because it was a really fast executing demo.</p><p>Use the process browser in Instruments to choose the mono process running my app e.g. mono (16314).</p><p>Now that instruments is attached hit the big red record button and hit any key on you app to start collecting data. When you are finished just hit the top button in Instruments.</p><p>You should end up with something similar to this, I used a few cycles of my 68000 emulator to get this data:</p><figure class=8u><img src=/img/flame-on/trace.png></figure><h3 id=exporting-the-data>Exporting The Data</h3><p>Exporting the data is pretty easy, use expand all on a node in the collected data using <code>Cmd cLick</code>, you can also add filters to the data, I used <code>Atari</code> in the screen-shot above to constrain the output to nodes that contained <code>Atari</code>. Now select export from the instrument menu:<figure class=6u><img src=/img/flame-on/export.png></figure></p><h3 id=producing-the-flamegraph>Producing the FlameGraph</h3><p>Now you can open a move to the flamegraph repo that you cloned earlier and execute the following command replacing myoutput.csv|svg with your input/outputs.</p><pre><code>./stackcollapse-instruments.pl myoutput.csv | ./flamegraph.pl &gt;myoutput.svg
</code></pre><p>You should now have a funky FlameGraph!</p><figure><img src=/img/flame-on/68kcpusteps.svg></figure><p>You could quite easily post process the csv output to clean up the mangled names that are a result of the AOT process.</p><p>Until next time &mldr;</p></div></section><section class="pagination clearfix"><a class="btn previous" href=https://7sharp9.dev/fsharp/2016-03-06-building-emulators-in-fsharp/>Building Emulators in FSharp</a>
<a class="btn next" href=https://7sharp9.dev/fsharp/2016-05-31-new-adventures/>New Adventures</a></section></div><footer><div class="footer-info pull-right">Â© 2021 Dave Thomas</div></footer><script src=https://7sharp9.dev/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-10152365-8','auto'),ga('send','pageview')</script></body></html>