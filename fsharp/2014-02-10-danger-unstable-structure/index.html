<!doctype html><html><head><title>Danger unstable structure - No more! &#183; 7sharp9</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.82.1"><link rel=stylesheet href=https://7sharp9.dev/css/vec.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.ico><link href rel=alternate type=application/rss+xml title=7sharp9></head><body><header><nav><ul><li class=pull-left><a href=https://7sharp9.dev/>/Home</a></li><li class=pull-left><a href=/about>/About</a></li><li class=pull-left><a href=/fsharp>/F#</a></li><li class=pull-left><a href=/running>/Running</a></li><li class=pull-left><a href=/elm>/Elm</a></li><li class=pull-right><a href><i class="fas fa-rss"></i></a></li></ul></nav></header><div class="content wide"><section class=post><h1 class=post-title><a href=https://7sharp9.dev/fsharp/2014-02-10-danger-unstable-structure/>Danger unstable structure - No more!</a></h1><span class=post-date>Feb 10, 2014</span><div class=post-content><figure class="img-left sixth"><img src=https://lh4.googleusercontent.com/-dJcVwxtDxw8/Uvaxn7dezqI/AAAAAAAAByo/QffHElmM96I/s512-no/IMG_0379.png></figure><p>Over the last year a lot of work has been done on the <a href=http://fsharp.github.io/fsharpbinding/>F# addin</a> for <a href=https://xamarin.com/studio>Xamarin Studio</a>. Lots of great new features have been added and a lot of bugs have been squashed. I want to talk a bit about whats been happening and the evolution of the F# addin.</p><p>The F# addin for <a href=http://monodevelop.com>MonoDevelop</a> / <a href=https://xamarin.com/studio>Xamarin Studio</a> hasn&rsquo;t always been as stable and pretty as it is now. When I first started working on it I went through a rocky phase of just trying to get it to compile and install. There were a whole host of changes going on in MonoDevelop which caused a lot of head scratching and late nights. Of all the issues encountered tooltips were the absolute bane of my life, they were often horribly mangled like this:</p><figure><img src=https://lh5.googleusercontent.com/-12p4uUpRK4g/Uvjtt2WAe7I/AAAAAAAABzs/QaQ-Tw8jIDw/w924-h416-no/77e93b30-7fa2-11e2-9490-303b1f7cb8b3.png></figure><p>Or completion lists were insanely long and downright pugly:<br><figure><img src=https://lh5.googleusercontent.com/-yZCVc4ymsGg/Uvsx_YwKbkI/AAAAAAAAB0w/NSvcqUyoC7w/w1400-h958-no/huge_overloads.png></figure></p><p>Modern IDE&rsquo;s have features like tooltips and auto completions which are so intrinsic that without them you feel a little lost without them, instead you have to rely on having eidetic memory of the various APIs and functions. Over the course of fixing bugs and adding new features inevitably you end up breaking lots of things which can make for a frustrating experience with half mangled IDE. Thankfully all these issues have now been addressed and lots of new features have also been added. Here are all the new features and improvements that have gone in over the last year or so.</p><h3 id=ui-improvements>UI Improvements</h3><h4 id=rename-refactoring>Rename refactoring</h4><p>One of the most recent and exciting new features is rename refactoring. Renaming can be achieved by either using a shortcut key <code>Meta R</code> or by right clicking and selecting rename from the context menu. Here&rsquo;s a screen cast of rename refactoring in action:<br></p><h4 id=highlight-usages>Highlight usages</h4><p>The precursor to rename refactoring was highlight usages, by clicking in the code editor the current identifier is highlighted and all occurrences of of that identifier are also highlighted. This makes it very easy to see where a specific identifier is used and is one of my favorite features:</p><figure><img src=https://lh5.googleusercontent.com/-Adx7bMfd7O0/UvtEs9UQdcI/AAAAAAAAB1w/aMva_sHDX1U/w880-h498-no/Screen+Shot+2014-02-12+at+09.51.17.png></figure><h4 id=tooltip-overload-refinements>Tooltip overload refinements</h4><p>Overload tooltips have now been refined so they look like the image below rather than the huge overload list shown at the top of this post.<br><figure><img src=https://lh3.googleusercontent.com/-hnmNtHIsrRU/UvtOB_yf0qI/AAAAAAAAB2U/FY3cMm-SY-0/w1400-h324-no/overload_enhancement.png></figure></p><h4 id=tooltip-arrow-indicators>Tooltip arrow indicators</h4><p>A little arrow indicators is now shown and positioned over the center of the tooltip. Yeah is only cosmetic but it was annoying having it missing.</p><h4 id=symbol-tooltips>Symbol tooltips</h4><p>We now also have tooltips for symbols, which makes custom symbol use more palatable. Now you can simply hover over the symbol see see its signature and xmldoc summary.<br><figure><img src=https://lh4.googleusercontent.com/-FFZtSnVdSkU/UvtVTNb5KlI/AAAAAAAAB2w/uPCpJhuOaoY/w642-h204-no/symbol+tooltips.png></figure></p><h4 id=drag-and-drop-file-ordering>Drag and drop file ordering</h4><p>F# source files can now be dragged in the Solution pad for correct ordering. This is limited to ordering files within a single folder at the moment. Source files can still be moved from one folder to another but they must be ordered as a separate operation.</p><h4 id=pathed-document-navigation>Pathed document navigation</h4><p>Pathed document navigation is implemented in the source window to aid navigation between modules, types and functions within a source file:</p><figure><img src=https://lh3.googleusercontent.com/-Evxt2R9Whr8/Uvt81UNJImI/AAAAAAAAB3M/_de-clz_b80/w1400-h878-no/pathed_doc.png></figure><h3 id=interactive-improvements>Interactive Improvements</h3><h4 id=send-all-project-references-to-fsi>Send all project references to FSI</h4><p>From the context menu or keyboard shortcut <code>Ctrl Meta P</code> you can choose to send all of the current projects reference to F# interactive, this saves having to enter a bunch of #r statements.</p><h4 id=send-line-moves-down-automatically>Send line moves down automatically</h4><p>For doing demos and testing scripts you can use a keyboard shortcut to sent the current line to F# interactive, the caret automatically drops down to the next line which makes stepping through the script a pinch.</p><h4 id=clearreset-fsi-keyboard-shortcuts>Clear/Reset FSI keyboard shortcuts</h4><p>By pressing <code>Ctrl Meta R</code> you can reset the current instance of F# interactive, similarly <code>Ctrl Meta C</code> will clear the current F# interactive window.</p><h4 id=fsi-theming>FSI theming</h4><p>You can now also choose to have F# interactive match you current theme colours or pick your own:<br><figure class=6u><img src=https://lh4.googleusercontent.com/-81Lw7ySfNRE/Uvs6_xH8pcI/AAAAAAAAB1Q/eO1Y2LmbT_E/w1400-h874-no/themed_fsi.png></figure></p><h3 id=engineering-improvements>Engineering improvements</h3><p>Originally we had a reflective binding to the F# compiler services which meant it was version agnostic but quite difficult to debug and add new features to.</p><p>Actually just for posterity, and you might find this useful/interesting heres the code, it uses the <a href="http://v2matveev.blogspot.co.uk/2010/07/tricky-late-binding-operators.html?utm_source=feedburner&utm_medium=feed&utm_campaign=Feed:+OccasionalNotes+(Occasional+notes)">dynamic lookup operator</a> <code>(?)</code> :</p><pre><code>let (?) (o:obj) name : 'R =
  // The return type is a function, which means that we want to invoke a method
  if FSharpType.IsFunction(typeof&lt;'R&gt;) then
    let argType, resType = FSharpType.GetFunctionElements(typeof&lt;'R&gt;)
    FSharpValue.MakeFunction(typeof&lt;'R&gt;, fun args -&gt;
      // We treat elements of a tuple passed as argument as a list of arguments
      // When the 'o' object is 'System.Type', we call static methods
      let methods, instance, args, owner = 
        let args = 
          if Object.Equals(argType, typeof&lt;unit&gt;) then [| |]
          elif not(FSharpType.IsTuple(argType)) then [| args |]
          else FSharpValue.GetTupleFields(args)
        if (typeof&lt;System.Type&gt;).IsAssignableFrom(o.GetType()) then 
          let methods = (unbox&lt;Type&gt; o).GetMethods(staticFlags) |&gt; Array.map asMethodBase
          let ctors = (unbox&lt;Type&gt; o).GetConstructors(ctorFlags) |&gt; Array.map asMethodBase
          let owner = (unbox&lt;Type&gt; o).Name + &quot; (static)&quot;
          Array.concat [ methods; ctors ], null, args, owner
        else 
          let owner = o.GetType().Name + &quot; (instance)&quot;
          o.GetType().GetMethods(instanceFlags) |&gt; Array.map asMethodBase, o, args, owner
      
      // A simple overload resolution based on the name and number of parameters only
      let methods = 
        [ for m in methods do
            if m.Name = name &amp;&amp; m.GetParameters().Length = args.Length then yield m 
            if m.Name = name &amp;&amp; m.IsGenericMethod &amp;&amp;
               m.GetGenericArguments().Length + m.GetParameters().Length = args.Length then yield m ]
      match methods with 
      | [] -&gt; failwithf &quot;No method '%s' with %d arguments found in %s&quot; name args.Length owner
      | _::_::_ -&gt; failwithf &quot;Multiple methods '%s' with %d arguments found %s&quot; name args.Length owner
      | [:? ConstructorInfo as c] -&gt; c.Invoke(args)
      | [ m ] when m.IsGenericMethod -&gt;
          let tyCount = m.GetGenericArguments().Length
          let tyArgs = args |&gt; Seq.take tyCount 
          let actualArgs = args |&gt; Seq.skip tyCount
          let gm = (m :?&gt; MethodInfo).MakeGenericMethod [| for a in tyArgs -&gt; unbox a |]
          gm.Invoke(instance, Array.ofSeq actualArgs)
      | [ m ] -&gt; m.Invoke(instance, args) ) |&gt; unbox&lt;'R&gt;
  else
    // When the 'o' object is 'System.Type', we access static properties
    let typ, flags, instance = 
      if (typeof&lt;System.Type&gt;).IsAssignableFrom(o.GetType()) then unbox o, staticFlags, null
      else o.GetType(), instanceFlags, o
    
    // Find a property that we can call and get the value
    let prop = typ.GetProperty(name, flags)
    if Object.Equals(prop, null) then 
      // Find a field that we can read
      let fld = typ.GetField(name, flags)
      if Object.Equals(fld, null) then
        // Try nested type...
        let nested = typ.Assembly.GetType(typ.FullName + &quot;+&quot; + name)
        if Object.Equals(nested, null) then 
          failwithf &quot;Property, field or nested type '%s' not found in '%s' using flags '%A'.&quot; name typ.Name flags
        elif not ((typeof&lt;'R&gt;).IsAssignableFrom(typeof&lt;System.Type&gt;)) then
          failwithf &quot;Cannot return nested type '%s' as value of type '%s'.&quot; nested.Name (typeof&lt;'R&gt;.Name)
        else nested |&gt; box |&gt; unbox&lt;'R&gt;
      else
        // Get field value
        fld.GetValue(instance) |&gt; unbox&lt;'R&gt;
    else
      // Call property
      let meth = prop.GetGetMethod(true)
      if prop = null then failwithf &quot;Property '%s' found, but doesn't have 'get' method.&quot; name
      try meth.Invoke(instance, [| |]) |&gt; unbox&lt;'R&gt;
      with err -&gt; failwithf &quot;Failed to get value of '%s' property (of type '%s'), error: %s&quot; name typ.Name (err.ToString())
</code></pre><p>To use it a type wrapper had to be constructed a bit like this:</p><pre><code>let interactiveCheckerType = asmCompiler.GetType(&quot;Microsoft.FSharp.Compiler.SourceCodeServices.InteractiveChecker&quot;)

type InteractiveChecker(wrapped:obj) =
member x.TryGetRecentTypeCheckResultsForFile(filename:string, options:CheckOptions) =
   let res = wrapped?TryGetRecentTypeCheckResultsForFile(filename, options.Wrapped) : obj
   if res = null then None else
      let tuple = res?Value
      Some(UntypedParseInfo(tuple?Item1), TypeCheckResults(tuple?Item2), int tuple?Item3)
</code></pre><p>It was quite fiddly to get right as <code>FSharp.Core</code> had to be used reflectively as you would potentially be using a different version of <code>FSharp.Core</code> depending on what version of F# you were binding to. I think this kind of reflective calling could be simplified by creating an F# type provider, I can think of a variety of uses for something like this.</p><p>Ultimately a branch called <strong>hardbinding</strong> was created which led to the creation of the F# Compiler Editor branch of the F# compiler. Slowly over the last few months that evolved into the <a href=http://fsharp.github.io/FSharp.Compiler.Service/>FSharp Compiler Service</a> aka <strong>FCS</strong>.</p><p>I also experimented quite a bit with a custom tokeniser that allowed the keywords and other syntax elements to be highlighted as tooltips:</p><p><figure><img src=https://lh4.googleusercontent.com/-_sHdxrBme-I/UvkMM1WVHHI/AAAAAAAAB0M/OtF0vnUdilI/w840-h344-no/keyword+tooltip.png></figure><br>At the time the F# binding was going through quite a turbulent change to the source code, and the combination of trying to develop FSharp.Compiler.Services and also refactoring the existing code meant that I decided to put this on hold for the time being. I hope to resurrected this work one day, I can see that keyword highlighting would be very useful to beginners, especially if a detailed description was available similar to what is available on MSDN. It also addresses some bugs that are still outstanding so it would be nice to get finished.</p><p>Over the last couple of months a lot of the common code around parsing of long identifiers has been refactored so that is can be shared with other tools. In the F# Binding we also have an emacs plugin which uses this shared code. We have also created a shared language agent which makes using these language services even easier still!</p><hr><h3 id=swat-all-the-bugs>Swat all the bugs!</h3><p>Anyone remember <a href=http://www.videogamehouse.net/picnicparanoia.html>Picnic paranoia</a>?<figure class=img-left><img src=http://i20.photobucket.com/albums/b223/NeoZeedeater/PicnicParanoiaTI.png><figcaption><h4>Swat all the bugs</h4></figcaption></figure></p><p>A shed load of bugs have also been swatted. Using the F# addin is no longer like ignoring the <strong>Unstable Structure sign</strong> and hoping things don&rsquo;t crumble under your feet. Admittedly there is still work to be done but some of the recent refactoring make it even easier to contribute to either new features or fixing bugs. We&rsquo;ve also added the F# binding to <a href=http://up-for-grabs.net/#/tags/f#>up-for-grabs.net</a> and added the <a href="https://github.com/fsharp/fsharpbinding/issues?direction=desc&labels=up-for-grabs&sort=created&state=open">up-for-grabs</a> issues as a starting point for anyone thinking about to helping out. There&rsquo;s been a lot of blood sweat and tears and its consumed quite a lot of my spare time but I hope you all enjoy using the new F# addin features.</p><p>Lastly a big thank you to everyone who has helped contribute over the last year, keep the contributions coming in!</p><p>That&rsquo;s all for now, see you next time!</p></div></section><section class="pagination clearfix"><a class="btn previous" href=https://7sharp9.dev/fsharp/2013-09-29-adding-touch-to-spritekit/>Adding Touch To SpriteKit</a>
<a class="btn next" href=https://7sharp9.dev/fsharp/2014-05-28-xamarin-3-fsharp-awsomeness/>Xamarin 3 F# Awesomeness</a></section><section id=disqus_thread class=disqus></section><script>var disqus_config=function(){this.page.url="https://7sharp9.dev/fsharp/2014-02-10-danger-unstable-structure/"};(function(){var a=document,b=a.createElement('script');b.src='//7sharp9.disqus.com/embed.js',b.setAttribute('data-timestamp',+new Date),(a.head||a.body).appendChild(b)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div><footer><div class="footer-info pull-right">© 2021 Dave Thomas</div></footer><script src=https://7sharp9.dev/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-10152365-8','auto'),ga('send','pageview')</script></body></html>